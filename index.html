<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fondamenti di Fisica Medica — Quiz a 3 opzioni</title>
  <style>
    :root {
      --bg:#0b0f1a; --card:#0b1220; --text:#ffffff; --muted:#dbe2ea; --ok:#22c55e; --err:#ef4444; --pri:#1d4ed8; --border:rgba(255,255,255,.2); --surface:rgba(255,255,255,.08);
    }
    body.hc{--bg:#000; --card:#000; --text:#fff; --muted:#f3f4f6; --pri:#0ea5e9; --border:rgba(255,255,255,.35); --surface:rgba(255,255,255,.12);}
    *{box-sizing:border-box}
    html{color-scheme:dark}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: var(--bg); color: var(--text); min-height:100vh; margin:0;
      display:grid; place-items:center; padding:18px; line-height:1.5;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    @media (max-width: 480px){ body{ padding:14px; } }

    .app{width:100%; max-width:900px; background: var(--card); border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,.6); overflow:hidden; border:1px solid var(--border)}
    header, footer{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:14px 18px; border-bottom:1px solid var(--border)}
    footer{border-top:1px solid var(--border); border-bottom:none}
    .title{font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted)}
    main{padding:18px}

    .question{font-size:clamp(20px,3.2vw,26px); font-weight:750}
    .note{color:var(--muted); margin-top:6px}

    .grid{display:grid; gap:14px; margin-top:16px; grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}

    .option{position:relative; border:1px solid var(--border); background: var(--surface); border-radius:14px; cursor:pointer; padding:12px; text-align:left; transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease}
    .option:hover{transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.5)}
    .thumb{width:100%; aspect-ratio:16/10; object-fit:cover; background:#0b1220; border-radius:10px; border:1px solid var(--border); display:block}
    .label{font-weight:700; margin-top:10px; font-size:18px}
    .option.text-only{display:flex; align-items:center; min-height:64px; padding:16px}
    .option.text-only .label{margin:0; font-size:18px}
    .option:focus-visible{outline:3px solid rgba(14,165,233,.85); outline-offset:2px}
    .option[data-state="correct"]{border-color: rgba(34,197,94,.9); box-shadow:0 0 0 3px rgba(34,197,94,.25) inset}
    .option[data-state="wrong"]{border-color: rgba(239,68,68,.9); box-shadow:0 0 0 3px rgba(239,68,68,.25) inset}

    .row{display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:16px; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; background: rgba(255,255,255,.12); color:var(--muted); font-size:14px; border:1px solid var(--border)}
    .btn{appearance:none; border:1px solid var(--border); border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer}
    .btn.primary{background: var(--pri); color:#fff; border-color: transparent; box-shadow:0 8px 22px rgba(29,78,216,.35)}
    .btn.secondary{background: rgba(255,255,255,.06); color: var(--text)}
    .btn:focus-visible{outline:3px solid rgba(14,165,233,.85); outline-offset:2px}

    .feedback{margin-top:12px; font-weight:800}
    .correct{color:var(--ok)}
    .incorrect{color:var(--err)}
    .hide{display:none!important}

    .progress{width:240px; height:12px; background:#334155; border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .progress>div{height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#34d399); transition:width .3s ease}

    .toggle{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.08); border:1px solid var(--border); cursor:pointer; font-weight:700}

    .intro-card{padding:18px}
    .choices{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .choice{padding:10px 14px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); cursor:pointer; font-weight:700}
    .choice[aria-pressed="true"]{background:rgba(29,78,216,.2); border-color:#60a5fa}
    .helper{font-size:14px; color:var(--muted); margin-top:6px}
    .small{font-size:13px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <div class="title">Fondamenti di Fisica Medica</div>
        <div class="muted" id="progressLabel">Metti alla prova le tue conoscenze</div>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <button id="contrastBtn" class="toggle" title="Cambia contrasto">Alto contrasto</button>
        <div class="progress" aria-label="Progresso quiz"><div id="progressBar"></div></div>
      </div>
    </header>

    <main>
      <!-- INTRO -->
      <div id="intro" class="intro-card">
        <div class="question">Parlaci di te: qual è il tuo background?</div>
        <div class="helper">Il quiz è totalmente anonimo.</div>
        <div class="choices" role="group" aria-label="Background">
          <button class="choice" data-cat="Medicina" aria-pressed="false">Medicina</button>
          <button class="choice" data-cat="STEM" aria-pressed="false">Lauree STEM</button>
          <button class="choice" data-cat="Altro" aria-pressed="false">Altro</button>
        </div>
        <div class="row" style="margin-top:16px">
          <span class="small">Alla fine potrai decidere se inviarci i tuoi risultati.</span>
          <button id="startBtn" class="btn primary" disabled>Inizia il quiz</button>
        </div>
      </div>

      <!-- QUIZ -->
      <div id="card" class="hide">
        <div class="question" id="questionText">Caricamento…</div>
        <div class="note" id="questionNote"></div>
        <div class="grid" id="optionsGrid" role="group" aria-label="Risposte"></div>
        <div class="feedback" id="feedback"></div>
        <div class="row">
          <span class="pill" id="scorePill">Punteggio: 0</span>
          <div>
            <button class="btn secondary" id="skipBtn">Salta</button>
            <button class="btn primary" id="nextBtn" disabled>Avanti</button>
          </div>
        </div>
      </div>

      <!-- RISULTATO -->
      <div id="result" class="hide">
        <h2 style="margin:0 0 8px 0">Fatto! 🎉</h2>
        <p class="muted" id="resultSummary"></p>

        <div class="row" style="margin-top: 16px;">
          <button class="btn primary" id="submitBtn">Invia i miei risultati</button>
          <button class="btn secondary" id="reviewBtn">Rivedi le risposte</button>
          <button class="btn secondary" id="restartBtn">Ricomincia il quiz</button>
        </div>
        <p class="small" id="submitStatus" style="margin-top:8px"></p>

        <div id="review" class="hide" style="margin-top:14px"></div>
      </div>
    </main>

    <footer>
      <span class="muted">Suggerimento: clicca o usa i tasti 1/2/3 per rispondere.</span>
      <span class="muted">Buona fortuna!</span>
    </footer>
  </div>

  <script>
    // ======= CONFIG: inserisci qui l'URL /exec dello Script Google =======
    const SUBMIT_URL = "YOUR_APPS_SCRIPT_EXEC_URL_HERE";

    // ======= DOMANDE =======
    const QUESTIONS = [
      {
        prompt: "Quale di queste tecniche usa radiazioni ionizzanti?",
        note: "Confronto tra TC, RM ed ecografia",
        options: [
          { text: "Risonanza Magnetica (RM)", correct: false },
          { text: "Tomografia Computerizzata (TC)", correct: true },
          { text: "Ecografia", correct: false },
        ]
      },
      {
        prompt: "In RM, l’intensità del campo magnetico si misura in…",
        note: "Unità di misura",
        options: [
          { text: "Gray (Gy)", correct: false },
          { text: "Tesla (T)", correct: true },
          { text: "Sievert (Sv)", correct: false },
        ]
      },
      {
        prompt: "Il Gray (Gy) misura…",
        note: "Dosimetria di base",
        options: [
          { text: "La dose assorbita", correct: true },
          { text: "L’attività di una sorgente", correct: false },
          { text: "La dose efficace", correct: false },
        ]
      },
      {
        prompt: "Quale delle seguenti immagini è una TC?",
        note: "Esempio con immagini",
        options: [
          { text: "A", img: "A.png", correct: true },
          { text: "B", img: "B.png", correct: false },
          { text: "C", img: "C.png", correct: false },
        ]
      },
      {
        prompt: "In ecografia, l’immagine si ottiene grazie a…",
        note: "Principio fisico",
        options: [
          { text: "Onde acustiche ad alta frequenza", correct: true },
          { text: "Raggi X", correct: false },
          { text: "Particelle beta", correct: false },
        ]
      },
      {
        prompt: "In PET si rivelano principalmente…",
        note: "Medicina nucleare",
        options: [
          { text: "Coppie di fotoni gamma da annichilazione positrone-elettrone", correct: true },
          { text: "Onde ultrasonore riflesse", correct: false },
          { text: "Emissione di luce visibile dai tessuti", correct: false },
        ]
      },
      {
        prompt: "Quale di questi esami espone tipicamente alla dose efficace più bassa?",
        note: "Ordini di grandezza (indicativi)",
        options: [
          { text: "Radiografia del torace", correct: true },
          { text: "TC addome", correct: false },
          { text: "PET/TC corpo intero", correct: false },
        ]
      },
      {
        prompt: "Quale delle seguenti immagini è stata acquisita tramite raggi X?",
        note: "Esempio immagini 2",
        options: [
          { text: "A", img: "RX.png", correct: true },
          { text: "B", img: "CT.png", correct: false },
          { text: "C", img: "MRI.png", correct: false },
        ]
      },
      {
        prompt: "Nella TC, l’unità di misura dell’attenuazione è…",
        note: "Scala di densità",
        options: [
          { text: "Unità Hounsfield (HU)", correct: true },
          { text: "Unità Tesla (T)", correct: false },
          { text: "Unità Becquerel (Bq)", correct: false },
        ]
      },
      {
        prompt: "Quale mezzo di contrasto è tipico della RM?",
        note: "Contrasti in imaging",
        options: [
          { text: "Agenti a base di gadolinio", correct: true },
          { text: "Agenti a base di iodio", correct: false },
          { text: "Solfato di bario", correct: false },
        ]
      },
      {
        prompt: "Perché si usano schermature (es. grembiuli) in radiografia?",
        note: "Protezione dei tessuti sensibili",
        options: [
          { text: "Per ridurre la dose a organi sensibili vicini all’area esaminata", correct: true },
          { text: "Per aumentare il contrasto dell’immagine", correct: false },
          { text: "Per velocizzare l’acquisizione", correct: false },
        ]
      },
      {
        prompt: "Qual è una controindicazione assoluta alla RM?",
        note: "Sicurezza in RM",
        options: [
          { text: "Pacemaker non compatibile con RM", correct: true },
          { text: "Protesi in titanio", correct: false },
          { text: "Otturazioni dentarie", correct: false },
        ]
      },
    ];

    // ======= STATO =======
    let index = 0; let score = 0; let locked = false; const history = [];
    let participantCategory = null;
    let currentRun = null;

    // ======= ELEMENTI =======
    const progressLabel = document.getElementById('progressLabel');
    const progressBar   = document.getElementById('progressBar');
    const questionText  = document.getElementById('questionText');
    const questionNote  = document.getElementById('questionNote');
    const optionsGrid   = document.getElementById('optionsGrid');
    const feedbackEl    = document.getElementById('feedback');
    const nextBtn       = document.getElementById('nextBtn');
    const skipBtn       = document.getElementById('skipBtn');
    const scorePill     = document.getElementById('scorePill');
    const result        = document.getElementById('result');
    const card          = document.getElementById('card');
    const resultSummary = document.getElementById('resultSummary');
    const restartBtn    = document.getElementById('restartBtn');
    const reviewBtn     = document.getElementById('reviewBtn');
    const reviewBox     = document.getElementById('review');
    const contrastBtn   = document.getElementById('contrastBtn');
    const intro         = document.getElementById('intro');
    const startBtn      = document.getElementById('startBtn');
    const submitBtn     = document.getElementById('submitBtn');
    const submitStatus  = document.getElementById('submitStatus');

    // ======= UTILITY =======
    function shuffle(arr){return arr.map(v=>({v,r:Math.random()})).sort((a,b)=>a.r-b.r).map(({v})=>v)}
    function updateProgress(){
      progressLabel.textContent = `Domanda ${index+1} di ${QUESTIONS.length}`;
      progressBar.style.width = `${(index/QUESTIONS.length)*100}%`;
      scorePill.textContent = `Punteggio: ${score}`;
    }

    // ======= RENDER =======
    function renderQuestion(){
      locked = false; feedbackEl.textContent = ''; nextBtn.disabled = true; optionsGrid.innerHTML = '';
      const q = QUESTIONS[index];
      questionText.textContent = q.prompt; questionNote.textContent = q.note || '';

      const opts = shuffle(q.options.map((o,i)=>({...o, idx:i})));
      opts.forEach((opt, position)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option' + (opt.img ? '' : ' text-only');
        btn.setAttribute('data-idx', opt.idx);
        btn.setAttribute('data-correct', !!opt.correct);
        btn.innerHTML = opt.img
          ? `<img class="thumb" src="${opt.img}" alt="${opt.text}"><div class="label">${position+1}. ${opt.text}</div>`
          : `<div class="label">${position+1}. ${opt.text}</div>`;
        btn.addEventListener('click', ()=>selectOption(btn));
        optionsGrid.appendChild(btn);
      });
      updateProgress();
    }

    function selectOption(btn){
      if(locked) return; locked = true;
      const isCorrect = btn.getAttribute('data-correct') === 'true';
      optionsGrid.querySelectorAll('.option').forEach(el=>{
        const corr = el.getAttribute('data-correct')==='true';
        el.dataset.state = corr ? 'correct' : (el===btn ? 'wrong' : '');
      });

      if(isCorrect){feedbackEl.textContent='Corretto!'; feedbackEl.className='feedback correct'; score++;}
      else{
        const q=QUESTIONS[index];
        const corrLabel=q.options.find(o=>o.correct)?.text||'la risposta corretta';
        feedbackEl.textContent=`Quasi! Corretto: ${corrLabel}`;
        feedbackEl.className='feedback incorrect';
      }

      history.push({qIndex:index, selected:Number(btn.getAttribute('data-idx')), correct:isCorrect});
      scorePill.textContent = `Punteggio: ${score}`; nextBtn.disabled = false;
      progressBar.style.width = `${((index+1)/QUESTIONS.length)*100}%`;
    }

    function nextQuestion(){ if(index < QUESTIONS.length-1){ index++; renderQuestion(); } else { showResult(); } }
    function skipQuestion(){ if(locked) return; history.push({qIndex:index, selected:null, correct:false, skipped:true}); nextQuestion(); }

    function renderReview(){
      const parts = history.map((h,i)=>{
        const q=QUESTIONS[h.qIndex];
        const corrIdx=q.options.findIndex(o=>o.correct);
        const selText=h.selected==null?'—':q.options[h.selected]?.text;
        const corrText=q.options[corrIdx]?.text;
        const status=h.correct?'✅':(h.skipped?'⏭️':'❌');
        return `<div style="padding:10px 12px; border:1px solid var(--border); border-radius:12px; margin-bottom:10px;">
          <div style="font-weight:800">Q${i+1}. ${q.prompt}</div>
          <div class="muted">Tua risposta: <b>${selText}</b> • Corretta: <b>${corrText}</b> ${status}</div>
        </div>`;
      }).join('');
      reviewBox.innerHTML = parts || '<div class="muted">Nessuna risposta da rivedere.</div>';
      reviewBox.classList.remove('hide');
    }

    function showResult(){
      card.classList.add('hide'); result.classList.remove('hide');
      resultSummary.textContent = `Background: ${participantCategory} • Punteggio: ${score}/${QUESTIONS.length}.`;
      progressLabel.textContent = 'Quiz completato'; progressBar.style.width = '100%';
      currentRun = saveRun(); // salva localmente questa esecuzione
      submitStatus.textContent = '';
      submitBtn.disabled = false;
    }

    function restart(){
      result.classList.add('hide'); reviewBox.classList.add('hide');
      intro.classList.remove('hide'); card.classList.add('hide');
      progressLabel.textContent = 'Scegli il tuo background per iniziare';
      progressBar.style.width = '0%';
      index=0; score=0; locked=false; history.length=0;
      scorePill.textContent = 'Punteggio: 0';
    }

    // ======= PERSISTENZA (locale) =======
    const STORAGE_KEY = 'quizRuns_v1';
    function getAllRuns(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch{ return []; } }
    function setAllRuns(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function saveRun(){
      const timestamp = new Date().toISOString();
      const runId = (crypto && crypto.randomUUID) ? crypto.randomUUID()
                  : 'run_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);

      const perQuestion = history.map(h => ({
        qIndex: h.qIndex,
        selectedIndex: (h.selected == null ? '' : h.selected)
      }));

      const run = {
        runId,
        timestamp,
        category: participantCategory,
        score,
        perQuestion
      };

      const all = getAllRuns(); all.push(run); setAllRuns(all);
      return run;
    }

    // ======= INVIO RISULTATI (webhook facoltativo) =======
    function submitResults(run){
      if(!SUBMIT_URL){ alert("Nessun SUBMIT_URL configurato nel codice."); return; }
      submitBtn.disabled = true;
      submitStatus.textContent = "Invio in corso...";
      fetch(SUBMIT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(run),
        mode: 'no-cors' // semplice: la richiesta arriva anche senza CORS espliciti
      }).then(()=>{
        submitStatus.textContent = "✅ Risultati inviati!";
        submitBtn.textContent = "Inviato";
        submitBtn.disabled = true;
      }).catch(()=>{
        submitStatus.textContent = "⚠️ Invio non riuscito. Riprova.";
        submitBtn.disabled = false;
      });
    }

    // ======= INTRO =======
    document.querySelectorAll('.choice').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.choice').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        participantCategory = btn.getAttribute('data-cat');
        startBtn.disabled = false;
      });
    });

    startBtn.addEventListener('click', ()=>{
      if(!participantCategory) return;
      intro.classList.add('hide');
      card.classList.remove('hide');
      index=0; score=0; locked=false; history.length=0;
      renderQuestion();
    });

    // ======= TASTIERA =======
    document.addEventListener('keydown', (e)=>{
      if(!result.classList.contains('hide') || card.classList.contains('hide')) return;
      if(['1','2','3'].includes(e.key)){
        const idx = Number(e.key)-1;
        const btn = optionsGrid.querySelectorAll('.option')[idx];
        if(btn) btn.click();
      } else if(e.key==='Enter'){
        if(!nextBtn.disabled) nextBtn.click();
      } else if(e.key.toLowerCase()==='s'){
        skipBtn.click();
      }
    });

    // ======= BOTTONI =======
    nextBtn.addEventListener('click', nextQuestion);
    skipBtn.addEventListener('click', skipQuestion);
    restartBtn.addEventListener('click', restart);
    reviewBtn.addEventListener('click', renderReview);
    submitBtn.addEventListener('click', ()=>{ if(currentRun) submitResults(currentRun); });

    // Toggle contrasto
    contrastBtn.addEventListener('click', () => {
      document.body.classList.toggle('hc');
      contrastBtn.textContent = document.body.classList.contains('hc') ? 'Contrasto standard' : 'Alto contrasto';
    });
  </script>
</body>
</html>
